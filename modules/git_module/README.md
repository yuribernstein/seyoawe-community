# üìò Git Module Documentation

---

## üß© Overview

The `git_module` provides GitOps-style capabilities for managing GitHub repositories as part of a SeyoAWE workflow. It supports operations like templated file creation, branch management, pull request automation, and repository cleanup.

This module is typically used as a **context module** ‚Äî initialized once and used throughout the workflow via `context.git`.

---

## üîß Setup (Context Module)

```yaml
context_modules:
  git:
    module: git_module.Git
    repo: "https://github.com/org/repo.git"  # Required
    branch: "feature/{{ context.user }}"     # Required (can use context vars)
    base_branch: "main"                      # Optional (default: "main")
    work_dir: "/tmp/gitops-{{ context.user }}" # Optional (default: /tmp/gitops)
    handle_existing_branch: "pull"           # Optional: "pull" or "fail" (default: "fail")
    ssh_key: "{{ context.git_ssh_key }}"     # Optional: SSH private key path
```

> Requires a `github_token` in `context_variables`.

---

## üöÄ Supported Actions

| Action                             | Description |
|-----------------------------------|-------------|
| `context.git.create_branch`       | Creates a new branch from the base branch |
| `context.git.add_file_from_template` | Renders a Jinja2 template and commits it |
| `context.git.add_files_from_templates` | Renders and commits multiple files |
| `context.git.open_pr`             | Creates a pull request |
| `context.git.merge_pr`            | Merges an open PR using squash strategy |
| `context.git.close_pr`            | Closes an open PR |
| `context.git.get_status`          | Returns current branch, dirty state, and untracked files |
| `context.git.cleanup`             | Deletes the local cloned repo (cleanup step) |

---

## üîÅ Example Workflow

```yaml
workflow:
  name: git_module_full_test

  context_variables:
    - name: github_token
      default: "ghp_xxx..."  # Required GitHub token
    - name: channel
      default: "#devops"

  context_modules:
    git:
      module: git_module.Git
      repo: "https://github.com/org/repo.git"
      branch: "feature/{{ context.user }}"
      base_branch: "main"
      handle_existing_branch: "pull"

  steps:
    - id: render_file
      type: action
      action: context.git.add_file_from_template
      input:
        template: "env_config.yaml.j2"
        destination: "envs/{{ context.user }}/config.yaml"

    - id: get_status
      type: action
      action: context.git.get_status
      register_output: repo_status

    - id: notify_status
      type: action
      action: slack_module.Slack.send_info_message
      input:
        channel: "{{ context.channel }}"
        title: "üîß Repo Status"
        keyed_message:
          - key: "Branch"
            value: "{{ context.repo_status.current_branch }}"
          - key: "Dirty"
            value: "{{ context.repo_status.is_dirty }}"
          - key: "Untracked"
            value: "{{ context.repo_status.untracked_files | tojson }}"

    - id: open_pr
      type: action
      action: context.git.open_pr
      input:
        title: "Provisioning PR for {{ context.user }}"
        body: "Generated by GitOps flow"
      register_output: pr_info

    - id: approve_merge
      type: approval
      message: "Approve to merge PR #{{ context.pr_info.pr_number }}?"
      timeout_minutes: 60
      delivery_step:
        id: announce
        type: action
        action: slack_module.Slack.send_info_message
        input:
          channel: "{{ context.channel }}"
          message: "Approve this PR: <{{ context.pr_info.url }}|View PR>"
          title: "‚è≥ Approval Needed"
          color: "warning"

    - id: merge_pr
      type: action
      action: context.git.merge_pr
      register_output: merge_result

    - id: notify_merge
      type: action
      action: slack_module.Slack.send_info_message
      input:
        channel: "{{ context.channel }}"
        title: "‚úÖ PR Merged"
        message: "PR <{{ context.pr_info.url }}|#{{ context.pr_info.pr_number }}> was merged successfully."
```

---

## üß† Developer Notes

- Class: `Git`  
- Location: `repos/modules/git_module/Git.py`
- Repo is cloned in `__init__` into `self.repo_dir`
- Template files must be located in: `repos/modules/git_module/templates/`

### GitHub API Requirements

- Token must have `repo` scope (for private repos)
- All PR operations use `requests` to interact with:
  - `https://api.github.com/repos/<owner>/<repo>/pulls`
